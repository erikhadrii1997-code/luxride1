<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a1a">
    <link rel="manifest" href="/manifest.json">
    <title>Luxride Driver - Earnings Analytics</title>
    <script type="module" src="https://cdn.jsdelivr.net/npm/@capacitor/core@latest/dist/capacitor.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary-color: #1a1a1a;
            --secondary-color: #2d2d2d;
            --accent-color: #d4af37;
            --accent-hover: #b8972e;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
            --info-color: #3b82f6;
            --text-primary: #1a1a1a;
            --text-secondary: #6b7280;
            --text-muted: #9ca3af;
            --bg-primary: #ffffff;
            --bg-secondary: #f8fafc;
            --bg-tertiary: #f1f5f9;
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            color: var(--text-primary);
            overscroll-behavior: none;
            overflow-x: hidden;
            line-height: 1.6;
            font-weight: 400;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            min-height: 100vh;
            max-height: 100vh;
            overflow-y: auto;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            min-height: calc(100vh - 30px);
            overflow-y: auto;
        }

        .header {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            padding: 1.5rem 0;
            margin-bottom: 1.5rem;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-left h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: linear-gradient(135deg, var(--accent-color) 0%, #f4d03f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .earnings-summary {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            backdrop-filter: blur(10px);
            flex-wrap: wrap;
            justify-content: center;
        }

        .summary-item {
            text-align: center;
            min-width: 80px;
        }

        .summary-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--accent-color);
            line-height: 1.2;
        }

        .summary-label {
            font-size: 0.75rem;
            opacity: 0.8;
            line-height: 1.2;
            white-space: nowrap;
        }

        .nav-bar {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: var(--bg-secondary);
            color: var(--text-primary);
            text-decoration: none;
            border-radius: 12px;
            font-weight: 500;
            transition: all 0.3s ease;
            border: 1px solid var(--border-color);
        }

        .nav-link:hover {
            background: var(--accent-color);
            color: white;
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .nav-link.active {
            background: var(--accent-color);
            color: white;
        }

        .earnings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .earnings-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
            height: 220px;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .earnings-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-xl);
        }

        .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .card-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
        }

        .card-icon.daily { background: linear-gradient(135deg, #3b82f6, #1d4ed8); }
        .card-icon.weekly { background: linear-gradient(135deg, #10b981, #059669); }
        .card-icon.monthly { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .card-icon.total { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }

        .card-value {
            font-size: 2.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .card-label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.95rem;
        }

        .card-change {
            font-size: 0.9rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .card-change.positive { color: var(--success-color); }
        .card-change.negative { color: var(--danger-color); }

        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .chart-card {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            height: 250px;
            display: flex;
            flex-direction: column;
        }

        .chart-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 0.75rem;
            flex: 1;
        }

        .summary-item {
            text-align: center;
            padding: 0.75rem;
            background: var(--bg-secondary);
            border-radius: 8px;
        }

        .summary-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--accent-color);
            margin-bottom: 0.25rem;
        }

        .summary-label {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .quick-stats {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.4rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-row span:first-child {
            color: var(--text-secondary);
            font-weight: 500;
        }

        .stat-row span:last-child {
            color: var(--text-primary);
            font-weight: 600;
        }

        .earnings-breakdown {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
            margin-bottom: 2rem;
        }

        .breakdown-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .breakdown-item:last-child {
            border-bottom: none;
        }

        .breakdown-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .breakdown-icon {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        .breakdown-icon.rides { background: var(--info-color); }
        .breakdown-icon.tips { background: var(--success-color); }
        .breakdown-icon.bonuses { background: var(--warning-color); }
        .breakdown-icon.fees { background: var(--danger-color); }

        .breakdown-details h4 {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .breakdown-details p {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .breakdown-amount {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .breakdown-amount.positive {
            color: var(--success-color);
        }

        .breakdown-amount.negative {
            color: var(--danger-color);
        }

        .recent-transactions {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .transaction-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
        }

        .transaction-item:last-child {
            border-bottom: none;
        }

        .transaction-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            color: white;
        }

        .transaction-icon.ride { background: var(--info-color); }
        .transaction-icon.tip { background: var(--success-color); }
        .transaction-icon.bonus { background: var(--warning-color); }
        .transaction-icon.fee { background: var(--danger-color); }

        .transaction-content {
            flex: 1;
        }

        .transaction-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .transaction-desc {
            font-size: 0.875rem;
            color: var(--text-secondary);
        }

        .transaction-amount {
            font-weight: 700;
            color: var(--text-primary);
        }

        .transaction-amount.positive {
            color: var(--success-color);
        }

        .transaction-amount.negative {
            color: var(--danger-color);
        }

        .transaction-time {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .filters {
            background: var(--bg-primary);
            border-radius: 16px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: var(--shadow-lg);
            border: 1px solid var(--border-color);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .filter-label {
            font-weight: 500;
            color: var(--text-primary);
        }

        .filter-select {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        @media (max-width: 1200px) {
            .charts-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            .container {
                padding: 1rem;
            }

            .header {
                padding: 1rem 0;
                margin-bottom: 1rem;
            }

            .header-content {
                flex-direction: column;
                gap: 1.5rem;
                text-align: center;
                padding: 0 1rem;
            }

            .header-left h1 {
                font-size: 1.5rem;
                margin-bottom: 0.25rem;
            }

            .header-left p {
                font-size: 0.875rem;
            }

            .header-right {
                flex-direction: column;
                gap: 1rem;
                width: 100%;
            }

            .earnings-summary {
                padding: 1rem;
                gap: 0.75rem;
                width: 100%;
                justify-content: space-around;
            }

            .summary-item {
                min-width: 70px;
            }

            .summary-value {
                font-size: 1.25rem;
            }

            .summary-label {
                font-size: 0.7rem;
            }

            .earnings-grid {
                grid-template-columns: 1fr;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }
        }

        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header fade-in">
            <div class="header-content">
                <div class="header-left">
                    <h1>Earnings Analytics</h1>
                    <p>Track your earnings and financial performance</p>
                </div>
                <div class="header-right">
                    <div class="earnings-summary">
                        <div class="summary-item">
                            <div class="summary-value" id="total-earnings">$0.00</div>
                            <div class="summary-label">Total Earnings</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="this-month">$0.00</div>
                            <div class="summary-label">This Month</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="avg-per-ride">$0.00</div>
                            <div class="summary-label">Avg per Ride</div>
                        </div>
                    </div>
                    <button id="logout-btn" class="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                        Logout
                    </button>
                </div>
            </div>
        </div>

        <!-- Navigation Bar -->
        <div class="nav-bar fade-in">
            <div class="nav-links">
                <a href="/driver-index" class="nav-link">
                    <i class="fas fa-home"></i>
                    Dashboard
                </a>
                <a href="/driver-dashboard" class="nav-link">
                    <i class="fas fa-chart-line"></i>
                    Analytics
                </a>
                <a href="/driver-rides" class="nav-link">
                    <i class="fas fa-car"></i>
                    Ride Management
                </a>
                <a href="/driver-orders" class="nav-link">
                    <i class="fas fa-clipboard-list"></i>
                    Order Management
                </a>
                <a href="/driver-schedule" class="nav-link">
                    <i class="fas fa-calendar-alt"></i>
                    Schedule
                </a>
                <a href="/driver-earnings" class="nav-link active">
                    <i class="fas fa-dollar-sign"></i>
                    Earnings
                </a>
                <a href="/driver-profile" class="nav-link">
                    <i class="fas fa-user"></i>
                    Profile
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="filters fade-in">
            <div class="filters-grid">
                <div class="filter-group">
                    <label class="filter-label">Time Period</label>
                    <select id="time-period" class="filter-select">
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month" selected>This Month</option>
                        <option value="quarter">This Quarter</option>
                        <option value="year">This Year</option>
                        <option value="all">All Time</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Earnings Type</label>
                    <select id="earnings-type" class="filter-select">
                        <option value="all">All Types</option>
                        <option value="rides">Rides Only</option>
                        <option value="tips">Tips Only</option>
                        <option value="bonuses">Bonuses Only</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Date Range</label>
                    <input type="date" id="start-date" class="filter-select">
                </div>
                <div class="filter-group">
                    <label class="filter-label">End Date</label>
                    <input type="date" id="end-date" class="filter-select">
                </div>
            </div>
        </div>

        <!-- Earnings Grid -->
        <div class="earnings-grid fade-in">
            <div class="earnings-card">
                <div class="card-header">
                    <div class="card-icon daily">
                        <i class="fas fa-calendar-day"></i>
                    </div>
                </div>
                <div class="card-value" id="daily-earnings">$0.00</div>
                <div class="card-label">Today's Earnings</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    +15% from yesterday
                </div>
            </div>

            <div class="earnings-card">
                <div class="card-header">
                    <div class="card-icon weekly">
                        <i class="fas fa-calendar-week"></i>
                    </div>
                </div>
                <div class="card-value" id="weekly-earnings">$0.00</div>
                <div class="card-label">This Week</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    +8% from last week
                </div>
            </div>

            <div class="earnings-card">
                <div class="card-header">
                    <div class="card-icon monthly">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                </div>
                <div class="card-value" id="monthly-earnings">$0.00</div>
                <div class="card-label">This Month</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    +12% from last month
                </div>
            </div>

            <div class="earnings-card">
                <div class="card-header">
                    <div class="card-icon total">
                        <i class="fas fa-chart-line"></i>
                    </div>
                </div>
                <div class="card-value" id="total-earnings-card">$0.00</div>
                <div class="card-label">Total Earnings</div>
                <div class="card-change positive">
                    <i class="fas fa-arrow-up"></i>
                    +25% this year
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="charts-grid fade-in">
            <div class="chart-card">
                <h2 class="chart-title">
                    <i class="fas fa-chart-line"></i>
                    Weekly Summary
                </h2>
                <div class="summary-stats">
                    <div class="summary-item">
                        <div class="summary-value">$1,250</div>
                        <div class="summary-label">This Week</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">45</div>
                        <div class="summary-label">Rides</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-value">$27.78</div>
                        <div class="summary-label">Avg per Ride</div>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <h2 class="chart-title">
                    <i class="fas fa-chart-pie"></i>
                    Quick Stats
                </h2>
                <div class="quick-stats">
                    <div class="stat-row">
                        <span>Best Day:</span>
                        <span>Friday</span>
                    </div>
                    <div class="stat-row">
                        <span>Peak Hours:</span>
                        <span>5-7 PM</span>
                    </div>
                    <div class="stat-row">
                        <span>Top Route:</span>
                        <span>Airport</span>
                    </div>
                    <div class="stat-row">
                        <span>Rating:</span>
                        <span>4.8 ⭐</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Earnings Breakdown -->
        <div class="earnings-breakdown fade-in">
            <h2 class="chart-title">
                <i class="fas fa-list"></i>
                Earnings Breakdown
            </h2>
            <div id="earnings-breakdown-list">
                <!-- Earnings breakdown will be populated here -->
            </div>
        </div>

        <!-- Recent Transactions -->
        <div class="recent-transactions fade-in">
            <h2 class="chart-title">
                <i class="fas fa-history"></i>
                Recent Transactions
            </h2>
            <div id="recent-transactions-list">
                <!-- Recent transactions will be populated here -->
            </div>
        </div>
    </div>

    <script>
        // Advanced Driver Earnings System
        class DriverEarnings {
            constructor() {
                this.user = null;
                this.earningsData = [];
                this.filteredData = [];
                this.filters = {
                    timePeriod: 'all',
                    earningsType: 'all',
                    startDate: null,
                    endDate: null
                };
                this.charts = {};
                this.init();
            }

            async init() {
                await this.checkUserAccess();
                await this.loadEarningsData();
                this.setupEventListeners();
                this.initializeCharts();
                this.updateEarningsDisplay();
                this.setupExportFeatures();
            }

            async checkUserAccess() {
                this.user = JSON.parse(localStorage.getItem('user') || '{}');
                
                if (!this.user.email) {
                    this.showNotification('Please login to access this page.', 'error');
                    setTimeout(() => {
                window.location.href = 'login.html';
                    }, 2000);
                    return false;
            }
                return true;
        }

            async             loadEarningsData() {
                try {
            const bookings = JSON.parse(localStorage.getItem('bookings') || '[]');
                    const completedBookings = bookings.filter(b => b.status === 'completed' && b.acceptedBy === 'John Smith');
                    
                    // Generate comprehensive earnings data from real completed rides
                    this.earningsData = completedBookings.map(booking => {
                        // Use real earnings data if available, otherwise calculate
                        if (booking.driverEarnings) {
                            return {
                                id: booking.id,
                                date: new Date(booking.completionDate || booking.timestamp),
                                amount: booking.driverEarnings.totalEarnings,
                                baseAmount: booking.driverEarnings.baseAmount,
                                tip: booking.driverEarnings.tip,
                                bonus: booking.driverEarnings.bonus,
                                fee: booking.driverEarnings.platformFee,
                type: 'ride',
                                description: `${booking.pickup} → ${booking.destination}`,
                                distance: booking.estimatedDistance || booking.distance || Math.random() * 20,
                                duration: booking.estimatedDuration || booking.duration || Math.random() * 60,
                                rating: booking.rating || (4 + Math.random()),
                                vehicleType: booking.vehicleType || booking.type,
                                originalPrice: booking.driverEarnings.originalPrice
                            };
                        } else {
                            // Fallback calculation for older bookings
                            const baseAmount = booking.price || 0;
                            const driverCut = baseAmount * 0.75;
                            const tip = Math.random() > 0.6 ? Math.random() * 5 : 0;
                            const bonus = Math.random() > 0.9 ? Math.random() * 10 : 0;
                            const platformFee = baseAmount * 0.25;
                            
                            return {
                                id: booking.id,
                                date: new Date(booking.completionDate || booking.timestamp),
                                amount: driverCut + tip + bonus,
                                baseAmount: driverCut,
                                tip: tip,
                                bonus: bonus,
                                fee: platformFee,
                                type: 'ride',
                                description: `${booking.pickup} → ${booking.destination}`,
                                distance: booking.estimatedDistance || booking.distance || Math.random() * 20,
                                duration: booking.estimatedDuration || booking.duration || Math.random() * 60,
                                rating: booking.rating || (4 + Math.random()),
                                vehicleType: booking.vehicleType || booking.type,
                                originalPrice: baseAmount
                            };
                        }
                    });

                    // Add some additional earnings types for variety (only if we have some real data)
                    if (this.earningsData.length > 0) {
                        this.addAdditionalEarnings();
                    }
                    
                } catch (error) {
                    console.error('Error loading earnings data:', error);
                    this.showNotification('Error loading earnings data', 'error');
                }
            }

            addAdditionalEarnings() {
                // Add weekly bonuses
                const weeklyBonuses = Array.from({length: 4}, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (i * 7));
                    return {
                        id: `bonus-${i}`,
                        date: date,
                        amount: 25 + Math.random() * 50,
                        baseAmount: 0,
                        tip: 0,
                        bonus: 25 + Math.random() * 50,
                        fee: 0,
                    type: 'bonus',
                        description: 'Weekly Performance Bonus',
                        distance: 0,
                        duration: 0,
                        rating: 0
                    };
                });

                // Add referral bonuses
                const referralBonuses = Array.from({length: 2}, (_, i) => {
                    const date = new Date();
                    date.setDate(date.getDate() - (i * 14));
                    return {
                        id: `referral-${i}`,
                        date: date,
                        amount: 15,
                        baseAmount: 0,
                        tip: 0,
                        bonus: 15,
                        fee: 0,
                        type: 'referral',
                        description: 'Referral Bonus',
                        distance: 0,
                        duration: 0,
                        rating: 0
                    };
                });

                this.earningsData.push(...weeklyBonuses, ...referralBonuses);
                this.earningsData.sort((a, b) => b.date - a.date);
            }

            applyFilters() {
                let filtered = [...this.earningsData];

                // Apply time period filter
                if (this.filters.timePeriod !== 'all') {
                    const now = new Date();
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    
                    switch (this.filters.timePeriod) {
                        case 'today':
                            filtered = filtered.filter(e => e.date >= today);
                            break;
                        case 'week':
                            const weekStart = new Date(today);
                            weekStart.setDate(today.getDate() - today.getDay());
                            filtered = filtered.filter(e => e.date >= weekStart);
                            break;
                        case 'month':
                            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
                            filtered = filtered.filter(e => e.date >= monthStart);
                            break;
                        case 'year':
                            const yearStart = new Date(now.getFullYear(), 0, 1);
                            filtered = filtered.filter(e => e.date >= yearStart);
                            break;
                    }
                }

                // Apply earnings type filter
                if (this.filters.earningsType !== 'all') {
                    filtered = filtered.filter(e => e.type === this.filters.earningsType);
                }

                // Apply date range filter
                if (this.filters.startDate) {
                    filtered = filtered.filter(e => e.date >= new Date(this.filters.startDate));
                }
                if (this.filters.endDate) {
                    const endDate = new Date(this.filters.endDate);
                    endDate.setHours(23, 59, 59, 999);
                    filtered = filtered.filter(e => e.date <= endDate);
                }

                this.filteredData = filtered;
            }

            updateEarningsDisplay() {
                this.applyFilters();
                
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() - today.getDay());
            const monthStart = new Date(now.getFullYear(), now.getMonth(), 1);
            
            // Calculate earnings for different periods
                const todayEarnings = this.earningsData
                .filter(e => e.date >= today)
                .reduce((sum, e) => sum + e.amount, 0);
            
                const weekEarnings = this.earningsData
                .filter(e => e.date >= weekStart)
                .reduce((sum, e) => sum + e.amount, 0);
            
                const monthEarnings = this.earningsData
                .filter(e => e.date >= monthStart)
                .reduce((sum, e) => sum + e.amount, 0);
            
                const totalEarnings = this.earningsData
                .reduce((sum, e) => sum + e.amount, 0);
            
                const filteredEarnings = this.filteredData
                    .reduce((sum, e) => sum + e.amount, 0);
                
                const avgPerRide = this.earningsData.length > 0 ? totalEarnings / this.earningsData.length : 0;
            
            // Update display
            document.getElementById('daily-earnings').textContent = `$${todayEarnings.toFixed(2)}`;
            document.getElementById('weekly-earnings').textContent = `$${weekEarnings.toFixed(2)}`;
            document.getElementById('monthly-earnings').textContent = `$${monthEarnings.toFixed(2)}`;
            document.getElementById('total-earnings-card').textContent = `$${totalEarnings.toFixed(2)}`;
            document.getElementById('total-earnings').textContent = `$${totalEarnings.toFixed(2)}`;
            document.getElementById('this-month').textContent = `$${monthEarnings.toFixed(2)}`;
            document.getElementById('avg-per-ride').textContent = `$${avgPerRide.toFixed(2)}`;
                
                // Update filtered earnings display
                const filteredEarningsElement = document.getElementById('filtered-earnings');
                if (filteredEarningsElement) {
                    filteredEarningsElement.textContent = `$${filteredEarnings.toFixed(2)}`;
                }
            
            // Update breakdown
                this.updateEarningsBreakdown();
            
            // Update recent transactions
                this.updateRecentTransactions();
                
                // Update charts
                this.updateCharts();
            }

            updateEarningsBreakdown() {
                const breakdownList = document.getElementById('earnings-breakdown-list');
                
                const breakdown = {
                    'Rides': this.filteredData.reduce((sum, e) => sum + e.baseAmount, 0),
                    'Tips': this.filteredData.reduce((sum, e) => sum + e.tip, 0),
                    'Bonuses': this.filteredData.reduce((sum, e) => sum + e.bonus, 0),
                    'Fees': this.filteredData.reduce((sum, e) => sum + e.fee, 0)
                };
                
                breakdownList.innerHTML = Object.entries(breakdown).map(([type, amount]) => `
                <div class="breakdown-item">
                        <div class="breakdown-type">${type}</div>
                        <div class="breakdown-amount">$${amount.toFixed(2)}</div>
                        </div>
                `).join('');
            }

            updateRecentTransactions() {
                const transactionsList = document.getElementById('recent-transactions-list');
                
                const recentTransactions = this.filteredData
                    .sort((a, b) => b.date - a.date)
                    .slice(0, 10);
            
            if (recentTransactions.length === 0) {
                    transactionsList.innerHTML = `
                    <div class="text-center py-8 text-gray-500">
                        <i class="fas fa-receipt text-4xl mb-4"></i>
                            <p>No transactions found</p>
                    </div>
                `;
                return;
            }
            
                transactionsList.innerHTML = recentTransactions.map(transaction => `
                    <div class="transaction-item" onclick="driverEarnings.viewTransactionDetails('${transaction.id}')">
                    <div class="transaction-icon ${transaction.type}">
                            <i class="fas fa-${transaction.type === 'ride' ? 'car' : transaction.type === 'bonus' ? 'gift' : 'user-plus'}"></i>
                    </div>
                    <div class="transaction-content">
                        <div class="transaction-title">${transaction.description}</div>
                            <div class="transaction-date">${transaction.date.toLocaleDateString()}</div>
                    </div>
                    <div class="transaction-amount ${transaction.amount >= 0 ? 'positive' : 'negative'}">
                        ${transaction.amount >= 0 ? '+' : ''}$${transaction.amount.toFixed(2)}
                    </div>
                </div>
            `).join('');
            }

            viewTransactionDetails(transactionId) {
                const transaction = this.earningsData.find(t => t.id === transactionId);
                if (!transaction) return;

                const details = `
Transaction ID: #${transaction.id.slice(-6)}
Type: ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}
Date: ${transaction.date.toLocaleDateString()}
Time: ${transaction.date.toLocaleTimeString()}
Description: ${transaction.description}
Base Amount: $${transaction.baseAmount.toFixed(2)}
Tip: $${transaction.tip.toFixed(2)}
Bonus: $${transaction.bonus.toFixed(2)}
Fee: $${transaction.fee.toFixed(2)}
Total: $${transaction.amount.toFixed(2)}
${transaction.distance ? `Distance: ${transaction.distance.toFixed(1)} miles` : ''}
${transaction.duration ? `Duration: ${transaction.duration.toFixed(0)} minutes` : ''}
${transaction.rating ? `Rating: ${transaction.rating.toFixed(1)}/5` : ''}
                `;
                
                this.showModal('Transaction Details', details);
            }

            initializeCharts() {
                this.initializeEarningsChart();
                this.initializeBreakdownChart();
            }

            initializeEarningsChart() {
                const ctx = document.createElement('canvas');
                ctx.id = 'earningsChart';
                ctx.width = 400;
                ctx.height = 200;
                
                const chartContainer = document.querySelector('.earnings-chart');
                if (chartContainer) {
                    chartContainer.appendChild(ctx);
                    
                    // Generate monthly earnings data
                    const monthlyData = this.generateMonthlyEarningsData();
                    
                    this.charts.earnings = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'],
                            datasets: [{
                                label: 'Monthly Earnings',
                                data: monthlyData,
                                borderColor: '#d4af37',
                                backgroundColor: 'rgba(212, 175, 55, 0.1)',
                                tension: 0.4,
                                fill: true
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    display: false
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    ticks: {
                                        callback: function(value) {
                                            return '$' + value;
                                        }
                                    }
                                }
                            }
                        }
                    });
                }
            }

            initializeBreakdownChart() {
                const ctx = document.createElement('canvas');
                ctx.id = 'breakdownChart';
                ctx.width = 300;
                ctx.height = 300;
                
                const chartContainer = document.querySelector('.breakdown-chart');
                if (chartContainer) {
                    chartContainer.appendChild(ctx);
                    
                    this.charts.breakdown = new Chart(ctx, {
                        type: 'doughnut',
                        data: {
                            labels: ['Rides', 'Tips', 'Bonuses', 'Fees'],
                            datasets: [{
                                data: [
                                    this.earningsData.reduce((sum, e) => sum + e.baseAmount, 0),
                                    this.earningsData.reduce((sum, e) => sum + e.tip, 0),
                                    this.earningsData.reduce((sum, e) => sum + e.bonus, 0),
                                    this.earningsData.reduce((sum, e) => sum + e.fee, 0)
                                ],
                                backgroundColor: ['#10b981', '#3b82f6', '#f59e0b', '#ef4444'],
                                borderWidth: 0
                            }]
                        },
                        options: {
                            responsive: true,
                            maintainAspectRatio: false,
                            plugins: {
                                legend: {
                                    position: 'bottom'
                                }
                            }
                        }
                    });
                }
            }

            generateMonthlyEarningsData() {
                const monthlyData = Array(12).fill(0);
                const currentMonth = new Date().getMonth();
                
                this.earningsData.forEach(earning => {
                    const month = earning.date.getMonth();
                    monthlyData[month] += earning.amount;
                });
                
                return monthlyData;
            }

            updateCharts() {
                if (this.charts.earnings) {
                    const monthlyData = this.generateMonthlyEarningsData();
                    this.charts.earnings.data.datasets[0].data = monthlyData;
                    this.charts.earnings.update();
                }

                if (this.charts.breakdown) {
                    this.charts.breakdown.data.datasets[0].data = [
                        this.filteredData.reduce((sum, e) => sum + e.baseAmount, 0),
                        this.filteredData.reduce((sum, e) => sum + e.tip, 0),
                        this.filteredData.reduce((sum, e) => sum + e.bonus, 0),
                        this.filteredData.reduce((sum, e) => sum + e.fee, 0)
                    ];
                    this.charts.breakdown.update();
                }
            }

            setupEventListeners() {
                const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => this.logoutDriver());
                }
                
                // Add event listeners for filters
                const timePeriodSelect = document.getElementById('time-period');
                const earningsTypeSelect = document.getElementById('earnings-type');
                const startDateInput = document.getElementById('start-date');
                const endDateInput = document.getElementById('end-date');
                
                if (timePeriodSelect) {
                    timePeriodSelect.addEventListener('change', (e) => {
                        this.filters.timePeriod = e.target.value;
                        this.updateEarningsDisplay();
                    });
                }
                if (earningsTypeSelect) {
                    earningsTypeSelect.addEventListener('change', (e) => {
                        this.filters.earningsType = e.target.value;
                        this.updateEarningsDisplay();
                    });
                }
                if (startDateInput) {
                    startDateInput.addEventListener('change', (e) => {
                        this.filters.startDate = e.target.value;
                        this.updateEarningsDisplay();
                    });
                }
                if (endDateInput) {
                    endDateInput.addEventListener('change', (e) => {
                        this.filters.endDate = e.target.value;
                        this.updateEarningsDisplay();
                    });
                }

                // Add refresh button
                const refreshBtn = document.createElement('button');
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt"></i> Refresh';
                refreshBtn.className = 'btn btn-secondary';
                refreshBtn.onclick = () => this.loadEarningsData();
                
                const headerRight = document.querySelector('.header-right');
                if (headerRight) {
                    headerRight.insertBefore(refreshBtn, headerRight.firstChild);
                }
            }

            setupExportFeatures() {
                // Add export button
                const exportBtn = document.createElement('button');
                exportBtn.innerHTML = '<i class="fas fa-download"></i> Export';
                exportBtn.className = 'btn btn-primary';
                exportBtn.onclick = () => this.exportEarnings();
                
                const headerRight = document.querySelector('.header-right');
                if (headerRight) {
                    headerRight.appendChild(exportBtn);
                }
            }

            exportEarnings() {
                const csvContent = this.generateCSV();
                const blob = new Blob([csvContent], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `earnings-${new Date().toISOString().split('T')[0]}.csv`;
                a.click();
                window.URL.revokeObjectURL(url);
                
                this.showNotification('Earnings data exported successfully!', 'success');
            }

            generateCSV() {
                const headers = ['Date', 'Type', 'Description', 'Base Amount', 'Tip', 'Bonus', 'Fee', 'Total'];
                const rows = this.filteredData.map(earning => [
                    earning.date.toLocaleDateString(),
                    earning.type,
                    earning.description,
                    earning.baseAmount.toFixed(2),
                    earning.tip.toFixed(2),
                    earning.bonus.toFixed(2),
                    earning.fee.toFixed(2),
                    earning.amount.toFixed(2)
                ]);
                
                return [headers, ...rows].map(row => row.join(',')).join('\n');
            }

            showNotification(message, type = 'info') {
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg text-white font-medium max-w-sm transform transition-all duration-300 translate-x-full`;
                
                switch (type) {
                    case 'success':
                        notification.className += ' bg-green-500';
                        break;
                    case 'error':
                        notification.className += ' bg-red-500';
                        break;
                    case 'warning':
                        notification.className += ' bg-yellow-500';
                        break;
                    default:
                        notification.className += ' bg-blue-500';
                }
                
                notification.innerHTML = `
                    <div class="flex items-center">
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'times' : 'info'} mr-2"></i>
                        <span>${message}</span>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // Animate in
                setTimeout(() => {
                    notification.classList.remove('translate-x-full');
                }, 100);
                
                // Remove after 3 seconds
                setTimeout(() => {
                    notification.classList.add('translate-x-full');
                    setTimeout(() => {
                        if (document.body.contains(notification)) {
                            document.body.removeChild(notification);
                        }
                    }, 300);
                }, 3000);
            }

            showModal(title, content) {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">
                        <h3 class="text-lg font-semibold mb-4">${title}</h3>
                        <div class="text-sm text-gray-600 whitespace-pre-line">${content}</div>
                        <div class="mt-6 flex justify-end">
                            <button class="btn btn-primary" onclick="this.closest('.fixed').remove()">Close</button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
            }

            logoutDriver() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem('user');
                localStorage.removeItem('userType');
                    this.showNotification('Logged out successfully!', 'success');
                    setTimeout(() => {
                window.location.href = 'login.html';
                    }, 1000);
                }
            }

            destroy() {
                Object.values(this.charts).forEach(chart => {
                    if (chart && chart.destroy) {
                        chart.destroy();
                    }
                });
            }
        }

        // Initialize earnings system when page loads
        let driverEarnings;
        document.addEventListener('DOMContentLoaded', function() {
            driverEarnings = new DriverEarnings();
        });

        // Cleanup when page unloads
        window.addEventListener('beforeunload', function() {
            if (driverEarnings) {
                driverEarnings.destroy();
            }
        });
    </script>
</body>
</html>
